<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>PPA Dashboard PRO v3.0</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#020617,#0f172a,#020617);color:#e5e7eb;margin:0;padding:24px}
h1{margin:0;font-size:28px}
p{color:#94a3b8;margin-top:4px}
textarea{width:100%;height:180px;border-radius:16px;border:1px solid #1e293b;padding:14px;font-size:13px;outline:none;white-space:pre;overflow:auto;background:#020617;color:#e5e7eb}
.controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px;align-items:center}
select,input,button{padding:10px 14px;border-radius:14px;border:none;font-weight:600;font-size:13px}
select,input{background:#020617;color:#e5e7eb;border:1px solid #1e293b}
button{cursor:pointer;transition:.25s;box-shadow:0 6px 18px rgba(0,0,0,.45)}
button:hover{transform:translateY(-2px)}
.btn-green{background:linear-gradient(135deg,#22c55e,#4ade80);color:#020617}
.btn-yellow{background:linear-gradient(135deg,#facc15,#fde047);color:#020617}
.info{margin-top:14px;font-size:14px;color:#cbd5f5}
.status-wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
.status-box{padding:16px;border-radius:18px;border:1px solid #1e293b;box-shadow:0 10px 25px rgba(0,0,0,.5)}
.ok-box{background:linear-gradient(135deg,#052e16,#022c22);border:1px solid #14532d}
.pend-box{background:linear-gradient(135deg,#3f2a00,#1e1300);border:1px solid #854d0e}
.status-title{font-weight:700;margin-bottom:6px}
.status-list span{display:inline-block;margin:4px 6px;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;background:#020617;border:1px solid #1e293b}
.status-list span:hover{background:#0f172a}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;margin-top:26px}
.card{background:linear-gradient(180deg,#020617,#0f172a);border-radius:20px;padding:12px;text-align:center;box-shadow:0 12px 28px rgba(0,0,0,.65);transition:.25s;border:1px solid #1e293b}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;border-radius:14px;background:#fff;cursor:pointer}
.ref{font-size:12px;color:#38bdf8;margin-top:6px;font-weight:600}
.desc{font-size:11px;color:#cbd5e1;margin-top:4px;line-height:1.3}
.badge{display:inline-block;margin-top:6px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;background:#7c2d12;color:#fdba74}
/* Tooltip */
.tooltip{position:relative}
.tooltip::after{content:attr(data-tip);position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:#020617;color:#e5e7eb;padding:6px 10px;border-radius:8px;font-size:11px;white-space:nowrap;opacity:0;pointer-events:none;transition:.2s;border:1px solid #1e293b;z-index:5}
.tooltip:hover::after{opacity:1}
/* Modal */
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(2,6,23,.92);display:none;align-items:center;justify-content:center;z-index:20;backdrop-filter:blur(6px)}
.modal-card{background:#020617;border-radius:20px;padding:20px;max-width:420px;width:90%;border:1px solid #1e293b;box-shadow:0 0 60px rgba(0,0,0,.8)}
.modal-card img{width:100%;border-radius:14px}
.modal-card h3{margin:10px 0 4px 0}
.modal-card p{margin:4px 0;font-size:13px;color:#cbd5e1}
.close{float:right;cursor:pointer;color:#94a3b8}
</style>
</head>
<body>
<h1>PPA Dashboard PRO 3.0</h1>
<p>Cole direto do PowerBI / Sheets / Excel (Ctrl+C / Ctrl+V)</p>

<textarea id="input" placeholder="Cole aqui os dados do PPA..."></textarea>

<div class="controls">
<button class="btn-green" onclick="processar()">Processar PPA</button>
<select id="filtroLoja" onchange="aplicarFiltros()"><option value="">Todas as lojas</option></select>
<select id="filtroTime" onchange="aplicarFiltros()"><option value="">Todos os times</option></select>
<input id="busca" placeholder="Buscar produto ou cÃ³digo" oninput="aplicarFiltros()">
<button class="btn-yellow" onclick="exportarCSV()">ðŸ“¥ Exportar CSV</button>
</div>

<div class="info" id="contador"></div>

<div class="status-wrap">
<div id="lojasOk" class="status-box ok-box"></div>
<div id="lojasPend" class="status-box pend-box"></div>
</div>

<div class="grid" id="resultado"></div>

<div class="modal" id="modal" onclick="fecharModal()">
  <div class="modal-card" onclick="event.stopPropagation()">
    <span class="close" onclick="fecharModal()">âœ–</span>
    <img id="modalImg">
    <h3 id="modalNome"></h3>
    <p id="modalRef"></p>
    <p id="modalLoja"></p>
    <p id="modalTime"></p>
  </div>
</div>

<script>
let pendentes = [];
let lojasStatus = {};

function detectarSeparador(linha){
    if(linha.includes('\t')) return '\t';
    if(linha.includes(';')) return ';';
    if(linha.includes(',')) return ',';
    return ' ';
}

function normalizar(t){return t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();}

function processar(){
    const texto = document.getElementById('input').value.trim();
    if(!texto) return;

    const linhas = texto.split(/\r?\n/).filter(l=>l.trim()!='');
    const sep = detectarSeparador(linhas[0]);
    const header = linhas[0].split(sep).map(h=>normalizar(h));

    const idx = {
        loja: header.findIndex(h=>h==='cod_loja'),
        ref: header.findIndex(h=>h==='cod_modelo_cor'),
        desc: header.findIndex(h=>h==='des_modelo_cor'),
        time: header.findIndex(h=>h==='primeiro'),
        pendente: header.findIndex(h=>h.includes('qtd modelocor pendente'))
    };

    pendentes = [];
    lojasStatus = {};

    for(let i=1;i<linhas.length;i++){
        const col = linhas[i].split(sep);
        if(col.length < 4) continue;

        const loja = col[idx.loja] || '';
        const ref = col[idx.ref] || '';
        const desc = col[idx.desc] || '';
        const time = col[idx.time] || '';
        const pend = Number(col[idx.pendente]);

        if(!lojasStatus[loja]) lojasStatus[loja]={total:0,pend:0};
        lojasStatus[loja].total++;

        if(pend === 1){
            lojasStatus[loja].pend++;
            if(ref) pendentes.push({loja,ref,desc,time});
        }
    }

    montarFiltros();
    montarStatus();
    render(pendentes);
}

function montarFiltros(){
    const lojas=[...new Set(pendentes.map(p=>p.loja).filter(v=>v))];
    const times=[...new Set(pendentes.map(p=>p.time).filter(v=>v))];

    const fLoja=document.getElementById('filtroLoja');
    const fTime=document.getElementById('filtroTime');

    fLoja.innerHTML='<option value="">Todas as lojas</option>';
    fTime.innerHTML='<option value="">Todos os times</option>';

    lojas.forEach(l=>{const o=document.createElement('option');o.value=l;o.textContent=l;fLoja.appendChild(o);});
    times.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;fTime.appendChild(o);});
}

function montarStatus(){
    const ok=[];
    const pend=[];

    Object.keys(lojasStatus).forEach(l=>{
        if(lojasStatus[l].pend===0) ok.push(l);
        else pend.push(l);
    });

    const okBox=document.getElementById('lojasOk');
    const pendBox=document.getElementById('lojasPend');

    okBox.innerHTML = `<div class='status-title'>ðŸŸ¢ Lojas 100% (${ok.length})</div><div class='status-list'>${ok.map(l=>`<span onclick=\"filtrarLoja('${l}')\">${l}</span>`).join('')}</div>`;
    pendBox.innerHTML = `<div class='status-title'>ðŸŸ¡ Lojas Pendentes (${pend.length})</div><div class='status-list'>${pend.map(l=>`<span onclick=\"filtrarLoja('${l}')\">${l}</span>`).join('')}</div>`;
}

function filtrarLoja(loja){
    document.getElementById('filtroLoja').value=loja;
    aplicarFiltros();
}

function aplicarFiltros(){
    const loja=document.getElementById('filtroLoja').value;
    const time=document.getElementById('filtroTime').value;
    const busca=document.getElementById('busca').value.toLowerCase();
    let f=pendentes;
    if(loja) f=f.filter(p=>p.loja===loja);
    if(time) f=f.filter(p=>p.time===time);
    if(busca) f=f.filter(p=>p.ref.toLowerCase().includes(busca)||p.desc.toLowerCase().includes(busca));
    render(f);
}

function render(lista){
    const grid=document.getElementById('resultado');
    const contador=document.getElementById('contador');
    grid.innerHTML='';
    contador.innerHTML=`ðŸ“Š PendÃªncias detectadas: <b>${lista.length}</b>`;

    lista.forEach(p=>{
        const imgUrl=`http://imgcentauro-a.akamaihd.net/900x900/${p.ref}.jpg`;
        const card=document.createElement('div');
        card.className='card tooltip';
        card.setAttribute('data-tip', p.desc);
        card.innerHTML=`
            <img src="${imgUrl}" onerror="this.src='https://via.placeholder.com/900x900?text=SEM+IMAGEM'">
            <div class="ref">${p.ref}</div>
            <div class="desc">${p.desc}</div>
            <span class="badge">Pendente</span>`;
        card.onclick=()=>abrirModal(p,imgUrl);
        grid.appendChild(card);
    });
}

function abrirModal(p,src){
    document.getElementById('modal').style.display='flex';
    document.getElementById('modalImg').src=src;
    document.getElementById('modalNome').innerText=p.desc;
    document.getElementById('modalRef').innerText='CÃ³digo: '+p.ref;
    document.getElementById('modalLoja').innerText='Loja: '+p.loja;
    document.getElementById('modalTime').innerText='Time: '+p.time;
}

function fecharModal(){document.getElementById('modal').style.display='none'}

function exportarCSV(){
    let csv='loja,referencia,descricao,time\n';
    pendentes.forEach(p=>{csv+=`${p.loja},${p.ref},"${p.desc}",${p.time}\n`;});
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='ppa_pendentes.csv';a.click();
}
</script>
</body>
</html>